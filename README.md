# Memcached Loader
Пакетный парсер логов, использующий multiprocessing. Парсит и загружает в memcache поминутную выгрузку логов трекера установленных приложений.

## Системные требования
- `Python` версии `3.12` или выше (исключая версию `3.12.5`, на ней не работает `black`)

## Установка

1. Склонируйте репозиторий:
```
git clone https://github.com/MegaDoge1337/otus_memcached_loader.git
```

2. Перейдите в директорию с проектом:
```
cd otus_memcached_loader
```

3. Создайте и активируйте виртуальное окружение. Пример для командной строки Windows 10:
```
python -m venv venv && .\venv\Scripts\activate
```

4. Установите зависимости:
```
pip install -r requirements.txt
```

5. Используйте protobuf, чтобы скомпилировать protobuf-сообщение:
```
protoc --python_out=. ./appsinstalled.proto
```

6. Для полноценного использования, запустите сервисы memcache (см. `Развертывание memcached`)

## Проверка и тестирование

Для запуска инструментов форматирования или тестов используйте Makefile

- Запуск теста protobuf-сообщения
```
make protobuf-test
```

- Запуск линтера
```
make lint
```

- Запуск форматирования
```
make format
```

- Запуск сортировки импортов
```
make import-sort
```

## Запуск

Для запуска приложения выполните скрипт `memc_load.py`:
```
python memc_load.py
```

Скрипт также имеет дополнительные параметры, которые можно указать при необходимости:
- `--test` - проверять корректность работы скомпилированного protobuf-сообщения;
- `--log` - путь к лог-файлу, по умолчанию лог не записывается в файл;
- `--dry` - скрипт обработает данные без подключения и записи в memcached;
- `--pattern` - шаблон поиска файлов для парсинга, по умолчанию `./data/appsinstalled/*.tsv.gz`;
- `--idfa` - адрес memcached, по умолчанию `127.0.0.1:33013`;
- `--gaid` - адрес memcached, по умолчанию `127.0.0.1:33014`;
- `--adid` - адрес memcached, по умолчанию `127.0.0.1:33015`;
- `--dvid` - адрес memcached, по умолчанию `127.0.0.1:33016`.

## Настройка

При необходимости отредактируйте следующие переменные скрипта:
```py
MEMC_BATCHES = 10          # Размер пакета данных, отправяемого в memcached
MEMC_SOCKET_TIMEOUT = 60   # Таймаут сокета memcached
MEMC_BATCHES_TIMEOUT = 60  # Таймаут отправки пакета данных в memcached
```

## Данные

В директории `./data/appinstalled` содержится файл `sample.tsv` и его сжатый вариант `sample.tsv.gz`, который можно использовать для проверки работы программы. Представляет собой шаблон лога, который парсит скрипт.

## Развертывание memcached

Для запуска стандартных сервисов memcached для каждого типа устройств (`idfa`, `gaid`, `adid`, `dvid`) используйте `docker-compose.yml`. Он содержит 4 контейнера с `memcached`, привязанных к портам хоста по умолчанию (33013 - 33016).
